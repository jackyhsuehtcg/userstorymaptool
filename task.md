# User Story Map Tool 任務分解

## 1. 基礎架構與共用設定
1. [x] 建立 React + TypeScript 前端專案，整合 React Flow、Zustand（含時間旅行中介層）、Bootstrap 5 與 TCRT 客製 SCSS。
2. [x] 設定 react-i18next 架構與 `locales/<lang>.json` 範本，定義 `ui`、`team`、`messages` 命名空間與 fallback 策略。
3. [x] 建立 NestJS 後端專案並劃分 Auth、Teams、StoryMap、Tokens、Audit、Config 等模組化結構。
4. [x] 設計 YAML 設定載入與環境變數覆寫機制，提供 `config/default.example.yaml`，更新 `.gitignore` 排除敏感檔。
5. [x] 建立 MongoDB 連線設定、健康檢查與 replica set 支援，啟用交易（session）。
6. [x] 定義 nodes、edges、auditLogs、apiTokens Schema 與索引策略，撰寫 migration framework 及範例腳本。
7. [x] 實作資料驗證層，涵蓋 ancestorPath 防迴圈、單一父節點約束、Cross Edge 參照、TeamId 驗證。
8. [x] 整合 TCRT OAuth/OIDC 流程與 API 客戶端（登入、登出、`GET /api/teams`、審計 API）。

## 2. 前端：UI 佈局與元件
1. [ ] 以 Bootstrap 5 建立左右分欄版面，左側顯示圖表、右側為編輯面板與搜尋區。
2. [ ] 使用 Bootstrap 表單、Modal、Toast、Toolbar 等元件，套用 TCRT 設計 Token 與樣式。
3. [ ] 建立全域通知與錯誤提示機制，支援匯入失敗、權限過期等情境。

## 3. 前端：樹狀視覺化與互動
1. [ ] 使用 React Flow 與 dagre 完成初始佈局、Team Space/Lane 分區與節點渲染（場景 1.1、1.6）。
2. [ ] 實作 Tree 結構變動時的重新佈局、手動位置優先邏輯與「重新套用佈局」控制（場景 1.2、1.4、1.5）。
3. [ ] 建立節點卡片 UI，顯示 ID、團隊、Summary、票證標籤與樣式（場景 1.3）。
4. [ ] 實作節點聚焦、高亮祖先鏈與跨邊鄰居、其餘節點淡化（場景 4.1）。
5. [ ] 建立畫布縮放、平移與 Zoom/Fit 控制按鈕（場景 5.1、5.2）。

## 4. 前端：節點操作
1. [ ] 建立節點選取狀態管理與右側編輯面板（場景 2.1）。
2. [ ] 實作團隊/摘要/描述/票證欄位編輯、根節點與子節點增刪流程，僅列出 `active=true` 團隊並處理缺失 TeamId 提示（場景 2.2-2.9）。
3. [ ] 支援拖放調整節點層級與兄弟排序，並提供非法操作回饋（場景 2.10、2.11）。

## 5. 前端：跨邊關係
1. [ ] 建立跨邊新增/刪除操作與驗證，維護 `type='cross'` 資料（場景 3.1、3.2）。
2. [ ] 實作跨邊自訂 SVG 視覺化、依 kind 顯示色彩與高亮樣式，支援跨 Team Space 鏈結與停用團隊警示（場景 3.3、3.5）。
3. [ ] 開發跨邊失效檢測與匯入異常移除/提示邏輯（場景 3.4）。

## 6. 前端：匯入匯出與錯誤處理
1. [ ] 實作匯出 `{nodes, edges}` JSON 功能與檔名規則（場景 6.1）。
2. [ ] 建立匯入流程：schema 驗證、TeamId 檢查、Undo/Redo 快照、React Flow 重繪、localStorage 同步（場景 6.2）。
3. [ ] 建立匯入失敗時的錯誤摘要、報告下載與狀態回復處理（場景 6.3）。
4. [ ] 確保匯出省略團隊清單並紀錄語系資訊，匯入時向 TCRT 驗證 TeamId（場景 7.4、13.5）。

## 7. 前端：TCRT 團隊資訊
1. [ ] 建立團隊資訊面板，顯示同步資料、fallback 提示與重新同步/管理連結（場景 7.1、7.2）。
2. [ ] 顯示同步時間戳、缺失 TeamId 的節點列表與重新指派指引（場景 7.3、1.6）。
3. [ ] 在匯入與同步流程提示停用團隊節點需重新指派（場景 7.4）。

## 8. 前端：節點搜尋面板
1. [ ] 建置 Bootstrap Accordion 搜尋面板，提供全文、團隊、票證、自訂標籤、時間範圍、父層、跨邊等篩選。
2. [ ] 實作搜尋結果表格、導覽至節點按鈕與 Saved Filters 儲存/載入（儲存在 MongoDB）。

## 9. 前端：多語系與翻譯管理
1. [ ] 建立語言切換器，支援異步載入、localStorage 記錄與 UI 更新（場景 13.2）。
2. [ ] 實作翻譯缺失 fallback 至 `fallbackName` 並記錄警告（場景 13.3）。
3. [ ] 設計翻譯資源版本檢測與重新載入提示流程（場景 13.4）。
4. [ ] 提供測試用翻譯檔與多語系測試覆蓋（場景 13.6）。

## 10. 前端：Undo/Redo 與快照協調
1. [ ] 使用 Zustand temporal middleware 實作復原/重做快捷鍵與快照上限 50（場景 11.1、11.2）。
2. [ ] 協調快照與持久化寫入延遲，避免快速操作造成狀態錯亂（場景 11.3）。

## 11. 前後端：資料管理與持久化
1. [ ] 完成初始載入流程：登入後呼叫 `GET /api/v1/map` 與 `GET /api/teams`，同步 Zustand、Team Space 與 localStorage（場景 10.1、8.4）。
2. [ ] 建立儲存機制：`PUT /api/v1/map`、Mongo 交易、成功後更新 localStorage 與 Undo/Redo 快照，失敗時顯示錯誤並禁止覆蓋（場景 10.2）。
3. [ ] 記錄團隊資料快取時間戳，限制快取 10 分鐘並允許離線快取模式提示（場景 10.1、10.2）。
4. [ ] 抽象化 persistence provider 介面以利未來儲存層替換（場景 10.3）。
5. [ ] 實作 TCRT API 失敗 fallback：標記快取可能過期、禁止團隊指派、提供重試與錯誤詳情（場景 10.4）。

## 12. 前端：身份與權限介面
1. [ ] 實作登入頁與 TCRT OAuth 導流，多語系錯誤提示（場景 8.0）。
2. [ ] 建立登入後的角色檢查，依 `storymap.*` 角色控制功能與提示無權限訊息（場景 8.2）。
3. [ ] 建立導覽列個人檔案面板、角色列表、頭像及「管理我的帳號」連結（場景 8.3）。
4. [ ] 開發登出流程與權限失效時的重新登入導引、未儲存變更警示（場景 8.5、8.6）。
5. [ ] 顯示重要操作需審計提示與連結（場景 8.7）。

## 13. 後端：身份驗證與授權
1. [ ] 實作 TCRT OAuth/OIDC callback、JWT 驗簽與 session 管理（場景 8.1）。
2. [ ] 建立角色對應與守門，保護編輯、匯入/匯出、API Token 管理等路由（場景 8.2）。
3. [ ] 提供登入狀態與個人檔案 API 供前端顯示（場景 8.3）。
4. [ ] 建立審計紀錄服務，記錄節點/跨邊/匯入/API Token 操作並可呼叫 TCRT 審計 API（場景 8.7）。

## 14. 後端：外部 API 與 Token 管理
1. [ ] 建立 API Token 管理介面與後端 CRUD，一次性顯示 Token 值並以 SHA-256 雜湊儲存（場景 14.1）。
2. [ ] 實作 `GET /api/v1/map` 與 `PUT /api/v1/map`，驗證 Token、權限與 TeamId，回傳 `X-Source-Locale` header（場景 14.2、14.3）。
3. [ ] 建立 Token 吊銷與輪替流程，停用後所有請求回傳 401 並提示管理者通知外部系統（場景 14.4）。
4. [ ] 實作 `GET /api/v1/nodes` / `GET /api/v1/nodes/:id` 查詢 API，支援篩選、分頁、父層資訊與 404 處理（場景 14.6）。
5. [ ] 加入 API 速率限制 (60 req/min)、錯誤處理訊息與審計紀錄（場景 14.5）。

## 15. 效能與穩定性
1. [ ] 針對 200+ 節點資料集優化首次載入與互動性能，啟用 React Flow 最佳化與節流機制。
2. [ ] 快取 Cross Edge 路徑，僅在相關節點移動時重新計算。
3. [ ] 當節點數超過 300 顯示警告並提供使用建議。
4. [ ] 完成匯入與驗證錯誤報告下載功能，輔助使用者排錯。

## 16. 測試與品質保證
1. [ ] 撰寫單元測試：Zustand actions、佈局邏輯、匯入驗證、權限守門、i18n fallback。
2. [ ] 撰寫整合測試：節點/邊線操作與 localStorage 同步、Team Space 更新、API 儲存流程。
3. [ ] 建立 E2E 測試：匯入 → 編輯 → 拖放 → 匯出、權限切換、語言切換、跨邊管理。
4. [ ] 測試 TCRT 團隊同步、快取逾時、停用團隊提示與錯誤重試。
5. [ ] 測試 API Token 流程、速率限制與審計紀錄寫入。

